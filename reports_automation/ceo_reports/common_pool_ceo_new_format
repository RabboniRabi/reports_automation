"""

Module with functions to:
- Create the common pool report for the CEO review report.
- The code will create 2 sheets, one for elementary schools (Primary & Middle Schools) and another for
    secondary schools (High & Higher Secondary Schools)

"""
import sys
sys.path.append('../')

import utilities.utilities as utilities
import functools as ft
import utilities.file_utilities as file_utilities
import utilities.dbutilities as dbutilities
import utilities.ranking_utilities as ranking_utilities
import utilities.report_utilities as report_utilities


import pandas as pd
import os
from datetime import date
from pathlib import Path

"""
Step 0:
Define the all the variables in the report


Step 1: 
Make the 3 main definitions "get_cp_ceoreview_summary",get_elementary



"""

"-----------------------------------------------------------------------------------------------------------------------"
# Step 0:
# Global variables
# Column names are defined here so that they can be edited in one place
total_student_count  = 'total'
students_ageing30_count = 'last_30days'
district_name = 'district_name'
udise_col = 'udise_code'
school_name ='school_name'
edu_district_name = 'edu_dist_name'
block_name = 'block_name'
school_category = 'category'
school_level = 'school_level'
class_number = 'class'
beo_user = 'beo_user'
beo_name ='beo_name'
deo_user_elm = 'deo_name (elementary)'
deo_user_sec = 'deo_name (secondary)'
cwsn_students ='cwsn'
beo_rank = 'BEO Rank'
deo_rank_elm = 'DEO Rank Elementary'
deo_rank_sec = 'DEO Rank Secondary'
perc_students_cp = '% Students ageing > 30 days'
total_cwsn_students ='cwsn'
total_cp_students ='total'
school_type ='school_type'

# Dictionary to define how the values to merge on and the how the merge will work.
merge_dict = {
    'on_values' : [district_name,block_name,school_name,school_category ,udise_col],
    'how' : 'left'
}

# index for pivoting
index = [district_name,deo_user_sec,deo_user_elm,school_category]


# Column order the final report will display
col_order = [district_name,deo_user_sec,deo_user_elm,school_level,school_category,1,2,3,4,5,6,7,8,9,10,11,'ageing',
               total_cp_students,total_cwsn_students]
"-----------------------------------------------------------------------------------------------------------------------"



def main():

    """""
    #code for running the sql script:

    # Read the database connection credentials
    credentials_dict = dbutilities.read_conn_credentials('db_credentials.json')

    # Get the latest students and teachers count
    df_report = dbutilities.fetch_data_as_df(credentials_dict, 'common_pool_latest.sql')

    print('df_report fetched from db: ', df_report)
    """

    common_pool_basefile = file_utilities.user_sel_excel_filename()
    raw_data = pd.read_excel(common_pool_basefile, sheet_name='Abstract')
    raw_data.drop(columns=edu_district_name, axis=1, inplace=True)
    raw_data = raw_data[~raw_data[school_type].isin(['Un-aided','Central Govt'])]

    # Update the data with the BRC-CRC mapping
    data_with_brc_mapping = report_utilities.map_data_with_brc(raw_data, merge_dict)
    data_with_brc_mapping.replace('Null', value=0, inplace=True)
    convert_dtype_columns = {students_ageing30_count: 'int', total_cp_students: 'int', total_cwsn_students: 'int',class_number:'int'}
    data_with_brc_mapping = data_with_brc_mapping.fillna(0).astype(convert_dtype_columns)
    data_with_brc_mapping = data_with_brc_mapping[~data_with_brc_mapping[school_level].isin([0])]
    #list_touse =  list(set(brc_crc_master_sheet.columns.to_list() + raw_data.columns.to_list()))
    #print(list_touse)

    # Pivot the data, grouping on


    data_pivot_ageing = pd.pivot_table(data_with_brc_mapping, values=students_ageing30_count, index=index
                              ,columns=[class_number], aggfunc='sum',fill_value=0).reset_index()
    print(data_pivot_ageing)


    data_pivot_total = pd.pivot_table(data_with_brc_mapping, values=total_cp_students, index=index,
                          aggfunc='sum').reset_index()

    data_pivot_cwsn = pd.pivot_table(data_with_brc_mapping, values=total_cwsn_students, index=index,
                           aggfunc='sum').reset_index()

    # Need to rewrite code below - add back deo details here
    data_to_addback = data_with_brc_mapping[index + [school_level]]


    data_to_addback = data_to_addback.drop_duplicates(subset=index,keep='first')

    data_frames_merge = [data_pivot_ageing,data_pivot_total,data_pivot_cwsn,data_to_addback]

    data_final = ft.reduce(lambda left, right: pd.merge(left, right, how='left',on=index), data_frames_merge)

    cols = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
    data_final['ageing'] = data_final[cols].sum(axis=1)


    data_final = data_final.loc[:,col_order]

    file_utilities.save_to_excel({'test2':data_final,'test3':data_pivot_ageing},'test7.xlsx')
    # Post creating data summary
    # Get the elementary report
    ranking_args_dict = {
        'agg_cols': ['ageing', 'total'],
        'agg_func': 'sum',
        'ranking_val_desc': '% ageing in CP',
        'num_col': 'ageing',
        'den_col': 'total',
        'sort': True,
        'ascending': True
    }
    elem_report = report_utilities.get_elementary_report(data_final, 'percent_ranking', ranking_args_dict, 'CP', 'Enrollment')
    sec_report = report_utilities.get_secondary_report(data_final, 'percent_ranking', ranking_args_dict, 'CP', 'Enrollment')


    file_utilities.save_to_excel({'CP_Elm': elem_report}, 'CP_Elm.xlsx',\
             dir_path = file_utilities.get_curr_month_elem_ceo_rpts_dir_path())

    file_utilities.save_to_excel({'CP_Sec': sec_report}, 'CP_Sec.xlsx',\
             dir_path = file_utilities.get_curr_month_secnd_ceo_rpts_dir_path())

if __name__ == "__main__":
    main()

